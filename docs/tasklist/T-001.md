# Задачи: T-001

**Status:** TASKLIST_READY

**PRD:** `docs/prd/T-001.prd.md`
**План:** `docs/plan/T-001.md`

## Прогресс

### Фаза 1: Скелет проекта
- [x] 1.1 Создать Gradle проект backend
- [x] 1.2 Создать Vite + React проект frontend
- [x] 1.3 Подключение к БД и миграции
- [x] 1.4 Базовые Ktor плагины

### Фаза 2: Авторизация
- [x] 2.1 Telegram initData валидация
- [x] 2.2 Endpoint POST /api/auth/init
- [x] 2.3 Auth middleware

### Фаза 3: Команды
- [x] 3.1 Модели и репозитории для Team/TeamMember
- [x] 3.2 CRUD команд (создание, получение)
- [x] 3.3 Присоединение по invite code
- [x] 3.4 Перегенерация invite code
- [x] 3.5 Управление участниками (роли, удаление)

### Фаза 4: События
- [x] 4.1 Модели и репозитории для Event
- [x] 4.2 CRUD событий
- [x] 4.3 Фоновая задача открытия записи
- [x] 4.4 Запись на события (Registration)

### Фаза 5: Состав
- [x] 5.1 Модели и репозитории для Lineup
- [x] 5.2 API сохранения/получения состава

### Фаза 6: Telegram Bot
- [ ] 6.1 Базовый бот с /start
- [ ] 6.2 Команда /connect для привязки чата
- [ ] 6.3 Уведомления в чат команды

### Фаза 7: Frontend
- [ ] 7.1 Telegram SDK интеграция и авторизация
- [ ] 7.2 Страница списка команд
- [ ] 7.3 Создание команды и вступление по коду
- [ ] 7.4 Страница команды (список событий)
- [ ] 7.5 Страница события с записью
- [ ] 7.6 Редактор состава для игры
- [ ] 7.7 Редактор состава для тренировки
- [ ] 7.8 Настройки команды (участники, invite code)

---

## Детали задач

### 1.1 Создать Gradle проект backend

**Описание:** Инициализировать Kotlin проект с Gradle (Kotlin DSL), добавить зависимости Ktor, Exposed, PostgreSQL, kotlinx.serialization.

**Файлы:**
- `backend/build.gradle.kts` — создать
- `backend/settings.gradle.kts` — создать
- `backend/gradle.properties` — создать
- `backend/src/main/kotlin/com/smena/Application.kt` — создать (минимальный hello world)
- `backend/src/main/resources/application.conf` — создать

**Критерии готовности:**
- [x] `./gradlew build` выполняется без ошибок
- [x] `./gradlew run` запускает сервер на порту 8080
- [x] GET / возвращает "Hello, World"

---

### 1.2 Создать Vite + React проект frontend

**Описание:** Инициализировать React проект с TypeScript, Vite, Tailwind CSS, React Router, React Query.

**Файлы:**
- `frontend/package.json` — создать
- `frontend/vite.config.ts` — создать
- `frontend/tsconfig.json` — создать
- `frontend/index.html` — создать
- `frontend/src/main.tsx` — создать
- `frontend/src/App.tsx` — создать

**Критерии готовности:**
- [x] `npm install` выполняется без ошибок
- [x] `npm run dev` запускает dev-сервер
- [x] Страница открывается в браузере
- [x] Tailwind стили работают

---

### 1.3 Подключение к БД и миграции

**Описание:** Настроить HikariCP connection pool, создать SQL миграции для всех таблиц.

**Файлы:**
- `backend/src/main/kotlin/com/smena/db/DatabaseFactory.kt` — создать
- `backend/src/main/resources/db/migration/V1__initial_schema.sql` — создать

**Критерии готовности:**
- [x] При старте приложения создаётся подключение к БД
- [x] Таблицы users, teams, team_members, events, registrations, lineups созданы
- [x] Индексы созданы

---

### 1.4 Базовые Ktor плагины

**Описание:** Настроить ContentNegotiation (JSON), CORS, StatusPages (обработка ошибок).

**Файлы:**
- `backend/src/main/kotlin/com/smena/plugins/ContentNegotiation.kt` — создать
- `backend/src/main/kotlin/com/smena/plugins/CORS.kt` — создать
- `backend/src/main/kotlin/com/smena/plugins/StatusPages.kt` — создать
- `backend/src/main/kotlin/com/smena/plugins/Routing.kt` — создать

**Критерии готовности:**
- [x] API возвращает JSON с правильным Content-Type
- [x] CORS разрешает запросы с localhost frontend
- [x] Ошибки возвращаются в формате `{ "error": { "code": "...", "message": "..." } }`

---

### 2.1 Telegram initData валидация

**Описание:** Реализовать валидацию HMAC-подписи initData от Telegram Mini App.

**Файлы:**
- `backend/src/main/kotlin/com/smena/telegram/InitDataValidator.kt` — создать

**Критерии готовности:**
- [x] Функция `validate(initData: String, botToken: String): TelegramUser?`
- [x] Возвращает данные пользователя при валидной подписи
- [x] Возвращает null при невалидной подписи
- [x] Юнит-тест с тестовыми данными

---

### 2.2 Endpoint POST /api/auth/init

**Описание:** Эндпоинт авторизации — принимает initData, создаёт/находит пользователя, возвращает профиль.

**Файлы:**
- `backend/src/main/kotlin/com/smena/models/User.kt` — создать
- `backend/src/main/kotlin/com/smena/repositories/UserRepository.kt` — создать
- `backend/src/main/kotlin/com/smena/services/AuthService.kt` — создать
- `backend/src/main/kotlin/com/smena/routes/AuthRoutes.kt` — создать
- `backend/src/main/kotlin/com/smena/dto/AuthRequest.kt` — создать
- `backend/src/main/kotlin/com/smena/dto/AuthResponse.kt` — создать

**Критерии готовности:**
- [x] POST /api/auth/init принимает `{ initData: string }`
- [x] При первом входе создаёт пользователя в БД
- [x] При повторном входе находит существующего
- [x] Возвращает `{ data: { user: {...}, teams: [...] } }`

---

### 2.3 Auth middleware

**Описание:** Middleware для защищённых эндпоинтов — проверяет заголовок Authorization.

**Файлы:**
- `backend/src/main/kotlin/com/smena/plugins/Authentication.kt` — создать

**Критерии готовности:**
- [x] Заголовок `Authorization: tma <initData>` проверяется
- [x] При отсутствии/невалидном заголовке — 401 Unauthorized
- [x] В контексте запроса доступен текущий пользователь

---

### 3.1 Модели и репозитории для Team/TeamMember

**Описание:** Создать Exposed таблицы и репозитории для команд и членства.

**Файлы:**
- `backend/src/main/kotlin/com/smena/models/Team.kt` — создать
- `backend/src/main/kotlin/com/smena/models/TeamMember.kt` — создать
- `backend/src/main/kotlin/com/smena/repositories/TeamRepository.kt` — создать
- `backend/src/main/kotlin/com/smena/repositories/TeamMemberRepository.kt` — создать

**Критерии готовности:**
- [x] Exposed Table objects для teams и team_members
- [x] CRUD операции в репозиториях
- [x] Генерация случайного invite_code (8 символов)

---

### 3.2 CRUD команд (создание, получение)

**Описание:** API для создания команды и получения списка своих команд.

**Файлы:**
- `backend/src/main/kotlin/com/smena/services/TeamService.kt` — создать
- `backend/src/main/kotlin/com/smena/routes/TeamRoutes.kt` — создать
- `backend/src/main/kotlin/com/smena/dto/CreateTeamRequest.kt` — создать
- `backend/src/main/kotlin/com/smena/dto/TeamResponse.kt` — создать

**Критерии готовности:**
- [x] POST /api/teams — создаёт команду, создатель становится ADMIN
- [x] GET /api/teams — возвращает список команд пользователя
- [x] GET /api/teams/{id} — возвращает детали команды

---

### 3.3 Присоединение по invite code

**Описание:** API для вступления в команду по коду приглашения.

**Файлы:**
- `backend/src/main/kotlin/com/smena/dto/JoinTeamRequest.kt` — создать
- `backend/src/main/kotlin/com/smena/routes/TeamRoutes.kt` — изменить

**Критерии готовности:**
- [x] POST /api/teams/join `{ inviteCode: string }` — добавляет в команду как PLAYER
- [x] Ошибка если код не найден
- [x] Ошибка если уже в команде

---

### 3.4 Перегенерация invite code

**Описание:** API для генерации нового кода приглашения (только ADMIN).

**Файлы:**
- `backend/src/main/kotlin/com/smena/routes/TeamRoutes.kt` — изменить

**Критерии готовности:**
- [x] POST /api/teams/{id}/regenerate-code — генерирует новый код
- [x] Только ADMIN может вызвать
- [x] Возвращает новый код

---

### 3.5 Управление участниками (роли, удаление)

**Описание:** API для просмотра участников, изменения ролей, удаления из команды.

**Файлы:**
- `backend/src/main/kotlin/com/smena/dto/MemberResponse.kt` — создать
- `backend/src/main/kotlin/com/smena/dto/UpdateMemberRequest.kt` — создать
- `backend/src/main/kotlin/com/smena/routes/TeamRoutes.kt` — изменить

**Критерии готовности:**
- [x] GET /api/teams/{id}/members — список участников
- [x] PATCH /api/teams/{id}/members/{userId} — изменить роль (только ADMIN)
- [x] DELETE /api/teams/{id}/members/{userId} — удалить (только ADMIN)
- [x] DELETE /api/teams/{id}/leave — покинуть команду

---

### 4.1 Модели и репозитории для Event

**Описание:** Создать Exposed таблицы и репозитории для событий.

**Файлы:**
- `backend/src/main/kotlin/com/smena/models/Event.kt` — создать
- `backend/src/main/kotlin/com/smena/repositories/EventRepository.kt` — создать

**Критерии готовности:**
- [x] Exposed Table object для events
- [x] CRUD операции в репозитории
- [x] Фильтрация по team_id, статусу, дате

---

### 4.2 CRUD событий

**Описание:** API для создания, редактирования, отмены событий.

**Файлы:**
- `backend/src/main/kotlin/com/smena/services/EventService.kt` — создать
- `backend/src/main/kotlin/com/smena/routes/EventRoutes.kt` — создать
- `backend/src/main/kotlin/com/smena/dto/CreateEventRequest.kt` — создать
- `backend/src/main/kotlin/com/smena/dto/EventResponse.kt` — создать

**Критерии готовности:**
- [x] POST /api/teams/{teamId}/events — создать (COACH/ADMIN)
- [x] GET /api/teams/{teamId}/events — список событий (предстоящие + прошедшие)
- [x] GET /api/teams/{teamId}/events/{id} — детали
- [x] PATCH /api/teams/{teamId}/events/{id} — редактировать
- [x] DELETE /api/teams/{teamId}/events/{id} — отменить (статус CANCELLED)
- [x] registration_opens_at = утро за день до события (автоматически)

---

### 4.3 Фоновая задача открытия записи

**Описание:** Корутина, которая периодически проверяет события и открывает запись.

**Файлы:**
- `backend/src/main/kotlin/com/smena/services/RegistrationOpenerService.kt` — создать
- `backend/src/main/kotlin/com/smena/Application.kt` — изменить

**Критерии готовности:**
- [x] Задача запускается при старте приложения
- [x] Каждые 5 минут проверяет SCHEDULED события
- [x] Меняет статус на OPEN если registration_opens_at <= NOW()
- [x] Логирует открытые события

---

### 4.4 Запись на события (Registration)

**Описание:** API для записи на событие.

**Файлы:**
- `backend/src/main/kotlin/com/smena/models/Registration.kt` — создать
- `backend/src/main/kotlin/com/smena/repositories/RegistrationRepository.kt` — создать
- `backend/src/main/kotlin/com/smena/services/RegistrationService.kt` — создать
- `backend/src/main/kotlin/com/smena/routes/RegistrationRoutes.kt` — создать

**Критерии готовности:**
- [x] GET /api/events/{eventId}/registrations — список записавшихся
- [x] POST /api/events/{eventId}/registrations `{ status: GOING | NOT_GOING }` — записаться
- [x] DELETE /api/events/{eventId}/registrations — удалить запись
- [x] Ошибка если запись не открыта (статус не OPEN)

---

### 5.1 Модели и репозитории для Lineup

**Описание:** Создать Exposed таблицы и репозитории для состава с поддержкой пятёрок.

**Файлы:**
- `backend/src/main/kotlin/com/smena/models/Lineup.kt` — создать
- `backend/src/main/kotlin/com/smena/repositories/LineupRepository.kt` — создать

**Критерии готовности:**
- [x] Exposed Table object для lineups (line_group, position)
- [x] CRUD операции в репозитории
- [x] Enum для LineGroup (LINE_1..4, GOALIES, LIGHT_1..2, DARK_1..2, etc.)
- [x] Enum для Position (LW, C, RW, LD, RD, G)

---

### 5.2 API сохранения/получения состава

**Описание:** API для формирования состава тренером.

**Файлы:**
- `backend/src/main/kotlin/com/smena/services/LineupService.kt` — создать
- `backend/src/main/kotlin/com/smena/routes/LineupRoutes.kt` — создать
- `backend/src/main/kotlin/com/smena/dto/LineupRequest.kt` — создать
- `backend/src/main/kotlin/com/smena/dto/LineupResponse.kt` — создать

**Критерии готовности:**
- [x] GET /api/events/{eventId}/lineup — текущий состав
- [x] PUT /api/events/{eventId}/lineup — сохранить состав (только COACH)
- [x] Принимает `{ entries: [{ userId, lineGroup, position }] }`
- [x] Валидация: игрок должен быть записан на событие (GOING)

---

### 6.1 Базовый бот с /start

**Описание:** Telegram бот с командой /start, открывающей Mini App.

**Файлы:**
- `backend/src/main/kotlin/com/smena/telegram/Bot.kt` — создать
- `backend/src/main/kotlin/com/smena/Application.kt` — изменить

**Критерии готовности:**
- [ ] Бот запускается вместе с приложением (long polling)
- [ ] /start отвечает приветствием с inline-кнопкой "Открыть приложение"
- [ ] /start {inviteCode} — deep link для вступления

---

### 6.2 Команда /connect для привязки чата

**Описание:** Команда для привязки группового чата к команде.

**Файлы:**
- `backend/src/main/kotlin/com/smena/telegram/Bot.kt` — изменить

**Критерии готовности:**
- [ ] /connect INVITE_CODE в групповом чате
- [ ] Проверяет что отправитель — ADMIN команды
- [ ] Сохраняет chat_id в таблицу teams
- [ ] Отвечает "Чат привязан к команде X"

---

### 6.3 Уведомления в чат команды

**Описание:** Сервис отправки уведомлений о событиях в привязанный чат.

**Файлы:**
- `backend/src/main/kotlin/com/smena/telegram/NotificationService.kt` — создать
- `backend/src/main/kotlin/com/smena/services/EventService.kt` — изменить
- `backend/src/main/kotlin/com/smena/services/RegistrationOpenerService.kt` — изменить
- `backend/src/main/kotlin/com/smena/services/LineupService.kt` — изменить

**Критерии готовности:**
- [ ] Уведомление при создании события
- [ ] Уведомление при открытии записи
- [ ] Уведомление при формировании состава
- [ ] Уведомление при отмене события

---

### 7.1 Telegram SDK интеграция и авторизация

**Описание:** Настроить Telegram Mini App SDK, получать initData, авторизоваться на backend.

**Файлы:**
- `frontend/src/utils/telegram.ts` — создать
- `frontend/src/api/client.ts` — создать
- `frontend/src/api/auth.ts` — создать
- `frontend/src/hooks/useAuth.ts` — создать
- `frontend/src/App.tsx` — изменить

**Критерии готовности:**
- [ ] SDK инициализируется при загрузке
- [ ] initData получается из Telegram
- [ ] POST /api/auth/init вызывается при старте
- [ ] Пользователь сохраняется в контексте
- [ ] initData передаётся в заголовке всех запросов

---

### 7.2 Страница списка команд

**Описание:** Главная страница со списком команд пользователя.

**Файлы:**
- `frontend/src/pages/TeamsPage.tsx` — создать
- `frontend/src/api/teams.ts` — создать
- `frontend/src/hooks/useTeams.ts` — создать
- `frontend/src/types/index.ts` — создать

**Критерии готовности:**
- [ ] Отображается список команд пользователя
- [ ] Кнопки "Создать команду" и "Присоединиться"
- [ ] Клик по команде переходит на страницу команды
- [ ] Если одна команда — автоматический редирект

---

### 7.3 Создание команды и вступление по коду

**Описание:** Страницы создания команды и вступления по invite code.

**Файлы:**
- `frontend/src/pages/CreateTeamPage.tsx` — создать
- `frontend/src/pages/JoinTeamPage.tsx` — создать

**Критерии готовности:**
- [ ] Форма создания команды (название)
- [ ] Форма ввода invite code
- [ ] После успеха — редирект на страницу команды
- [ ] Обработка ошибок (неверный код, уже в команде)

---

### 7.4 Страница команды (список событий)

**Описание:** Страница команды с вкладками "Предстоящие" / "Прошедшие".

**Файлы:**
- `frontend/src/pages/TeamPage.tsx` — создать
- `frontend/src/components/EventCard.tsx` — создать
- `frontend/src/api/events.ts` — создать
- `frontend/src/hooks/useEvents.ts` — создать

**Критерии готовности:**
- [ ] Список предстоящих событий (сортировка по дате)
- [ ] Список прошедших событий (отдельная вкладка)
- [ ] Карточка события: тип, дата, время, место, количество записавшихся
- [ ] Кнопка "Создать событие" (для COACH/ADMIN)
- [ ] Клик по событию переходит на детали

---

### 7.5 Страница события с записью

**Описание:** Детали события и кнопка записи.

**Файлы:**
- `frontend/src/pages/EventPage.tsx` — создать
- `frontend/src/components/RegistrationButton.tsx` — создать
- `frontend/src/components/RegistrationList.tsx` — создать
- `frontend/src/api/registrations.ts` — создать
- `frontend/src/hooks/useRegistration.ts` — создать

**Критерии готовности:**
- [ ] Детали события (дата, время, место, описание)
- [ ] Список записавшихся (GOING / NOT_GOING)
- [ ] Кнопка "Иду" / "Не иду" (если запись открыта)
- [ ] Сообщение "Запись откроется..." (если SCHEDULED)
- [ ] Состав (если сформирован)
- [ ] Кнопка "Сформировать состав" (для COACH/ADMIN)

---

### 7.6 Редактор состава для игры

**Описание:** Страница формирования состава для игры (3-4 пятёрки + вратари).

**Файлы:**
- `frontend/src/pages/LineupGamePage.tsx` — создать
- `frontend/src/components/LineupEditor.tsx` — создать
- `frontend/src/components/LineSlot.tsx` — создать
- `frontend/src/api/lineup.ts` — создать

**Критерии готовности:**
- [ ] Визуализация 3-4 пятёрок (LW, C, RW, LD, RD)
- [ ] Секция вратарей (2 слота)
- [ ] Список нераспределённых игроков (записавшихся GOING)
- [ ] Drag-and-drop игроков на позиции
- [ ] Кнопка добавить 4-ю пятёрку
- [ ] Кнопка "Сохранить состав"

---

### 7.7 Редактор состава для тренировки

**Описание:** Страница формирования состава для тренировки (Светлые / Тёмные).

**Файлы:**
- `frontend/src/pages/LineupTrainingPage.tsx` — создать
- `frontend/src/components/TeamColumn.tsx` — создать

**Критерии готовности:**
- [ ] Две колонки: Светлые / Тёмные
- [ ] В каждой: 2 пятёрки + вратарь
- [ ] Список нераспределённых игроков
- [ ] Drag-and-drop между колонками и позициями
- [ ] Кнопка "Сохранить состав"

---

### 7.8 Настройки команды (участники, invite code)

**Описание:** Страница настроек команды для админа.

**Файлы:**
- `frontend/src/pages/TeamSettingsPage.tsx` — создать
- `frontend/src/components/MembersList.tsx` — создать
- `frontend/src/components/InviteCode.tsx` — создать

**Критерии готовности:**
- [ ] Список участников с ролями
- [ ] Изменение роли (для ADMIN)
- [ ] Удаление участника (для ADMIN)
- [ ] Отображение invite code с кнопкой копирования
- [ ] Кнопка "Перегенерировать код"

---

## Заметки

- PostgreSQL уже установлен в системе, docker-compose не нужен
- Версии зависимостей уточнять через веб-поиск перед добавлением
- Для локальной разработки Mini App использовать ngrok или аналог для HTTPS
- Telegram Bot Token хранить в переменных окружения
